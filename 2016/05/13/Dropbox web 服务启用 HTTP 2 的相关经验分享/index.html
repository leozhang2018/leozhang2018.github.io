<!DOCTYPE html><html class="theme-next muse use-motion" lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="//fonts.googleapis.com/css?family=Exo 2:300,300italic,400,400italic,700,700italicExo 2:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css"><link href="https://lib.baomitu.com/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet" type="text/css"><link href="/css/main.css?v=6.0.3" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.0.3"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-64x64.png?v=6.0.3"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-32x32.png?v=6.0.3"><link rel="mask-icon" href="/images/logo.svg?v=6.0.3" color="#222"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Muse",version:"6.0.3",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!1,fastclick:!1,lazyload:!1,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><meta name="keywords" content="HTTP/2,翻译,"><meta name="description" content="在 Dropbox ，我们的运维团队于近日升级了前端 NGINX 服务器开启了 Web 服务的 HTTP/2 支持。在本篇文章中，我们将就此次 HTTP/2 的升级过渡，分享我们的一些经验以及相关发现。总体来说此次升级还算平滑，然而依旧踩了很多的“坑”碰到了不少注意事项，希望会对他人有所帮助。"><meta name="keywords" content="HTTP&#x2F;2,翻译"><meta property="og:type" content="article"><meta property="og:title" content="Dropbox Web 服务启用 HTTP&#x2F;2 的相关经验分享（译）"><meta property="og:url" content="https://code.leozhang2018.me/2016/05/13/Dropbox web 服务启用 HTTP 2 的相关经验分享/index.html"><meta property="og:site_name" content="leozhang2018"><meta property="og:description" content="在 Dropbox ，我们的运维团队于近日升级了前端 NGINX 服务器开启了 Web 服务的 HTTP/2 支持。在本篇文章中，我们将就此次 HTTP/2 的升级过渡，分享我们的一些经验以及相关发现。总体来说此次升级还算平滑，然而依旧踩了很多的“坑”碰到了不少注意事项，希望会对他人有所帮助。"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://code.leozhang2018.me/images/2016-05-13/banner.webp"><meta property="og:image" content="https://code.leozhang2018.me/images/2016-05-13/http2-transition.png"><meta property="og:image" content="https://code.leozhang2018.me/images/2016-05-13/traffic-bandwidth.png"><meta property="og:image" content="https://code.leozhang2018.me/images/2016-05-13/request-latency.png"><meta property="og:image" content="https://code.leozhang2018.me/images/2016-05-13/net-internals.png"><meta property="og:updated_time" content="2021-11-17T08:24:22.213Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Dropbox Web 服务启用 HTTP&#x2F;2 的相关经验分享（译）"><meta name="twitter:description" content="在 Dropbox ，我们的运维团队于近日升级了前端 NGINX 服务器开启了 Web 服务的 HTTP/2 支持。在本篇文章中，我们将就此次 HTTP/2 的升级过渡，分享我们的一些经验以及相关发现。总体来说此次升级还算平滑，然而依旧踩了很多的“坑”碰到了不少注意事项，希望会对他人有所帮助。"><meta name="twitter:image" content="https://code.leozhang2018.me/images/2016-05-13/banner.webp"><link rel="canonical" href="https://code.leozhang2018.me/2016/05/13/Dropbox web 服务启用 HTTP 2 的相关经验分享/"><script type="text/javascript" id="page.configurations">CONFIG.page={sidebar:""}</script><title>Dropbox Web 服务启用 HTTP/2 的相关经验分享（译） | leozhang2018</title><noscript><style type="text/css">.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">leozhang2018</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle"></p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section">首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section">标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section">归档</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section">关于</a></li></ul></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://code.leozhang2018.me/2016/05/13/Dropbox web 服务启用 HTTP 2 的相关经验分享/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="leozhang2018"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="leozhang2018"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Dropbox Web 服务启用 HTTP/2 的相关经验分享（译）</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-05-13T20:00:25+08:00">2016-05-13</time></span></div></header><div class="post-body" itemprop="articleBody"><p><img src="/images/2016-05-13/banner.webp" alt="Dropbox Web 服务启用 HTTP2 的相关经验分享"><br>在 Dropbox ，我们的运维团队于近日升级了前端 NGINX 服务器开启了 Web 服务的 HTTP/2 支持。在本篇文章中，我们将就此次 HTTP/2 的升级过渡，分享我们的一些经验以及相关发现。总体来说此次升级还算平滑，然而依旧踩了很多的“坑”碰到了不少注意事项，希望会对他人有所帮助。<br><a id="more"></a></p><h3 style="text-align:center">背景：HTTP/2 以及 Dropbox Web 服务架构</h3><br>HTTP/2（<a href="https://tools.ietf.org/html/rfc7540" target="_blank" rel="noopener">RFC 7540</a>）是新一代的 HTTP 协议版本，它基于 <a href="https://www.chromium.org/spdy" target="_blank" rel="noopener">SPDY</a>，相比于 HTTP/1.1 提供了数项性能优化。这些优化包括：更高效的首部压缩（Header compression）、服务端推送（Server push）、同一连接上的流复用（Stream multiplexing），等等。如今，<a href="http://caniuse.com/#feat=http2" target="_blank" rel="noopener">HTTP/2 已经被大部分浏览器所支持</a>。<br>Dropbox 使用开源的 NGINX 处理 SSL 连接并且对 Web 流量进行七层的负载均衡。在升级之前我们前端的 Web 服务器运行的是 NGINX 1.7 并且支持 SPDY。另一个顾虑则是 Chrome 虽同时支持 SPDY 以及 HTTP/2 ，但是官方将会<a href="http://blog.chromium.org/2016/02/transitioning-from-spdy-to-http2.html" target="_blank" rel="noopener">在 5 月 15 起，停止对 SPDY 的支持</a>。如果那时我们仍然不能提供 HTTP/2 的支持的话，意味着我们的 Chrome 客户将会从使用 SPDY 回退到 HTTP/1.1。<br><h3 style="text-align:center">HTTP/2 升级过程</h3><br>整个 HTTP/2 升级过程很平稳，Nginx 1.9.5 增加了 HTTP/2 模块（由 Dropbox 联合赞助）默认抛弃了对 SPDY 的支持。就我们而言，我们打算升级到 NGINX 1.9.15 ，也就是最新的 stable 版本。<br>NGINX 的升级包括基本的配置文件修改，启用 HTTP/2 的支持，需要将 <code>http2</code> 指令添加到 <code>listen</code> 字段。就我们而言，因为之前已经开启 SPDY，所以只需将 <code>spdy</code> 替换成 <code>http2</code> 就行了。<br><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Before  (SPDY): listen A.B.C.D:443 ssl spdy;</span><br><span class="line">After (HTTP/2): listen A.B.C.D:443 ssl http2;</span><br></pre></td></tr></table></figure><br><br>当然，如果你有相关的额外需求的话，也可以调节其他 <a href="http://nginx.org/en/docs/http/ngx_http_v2_module.html" target="_blank" rel="noopener">NGINX HTTP/2 的配置选项</a>。<br><br>我们在 Canary 版本的机器上部署了 HTTP/2 大约一周的时间，而此时生产环境使用的仍然是 SPDY。在验证正确性以及相关性能评估之后，我们为 Web 服务全线开启了 HTTP/2。<br><br><img src="/images/2016-05-13/http2-transition.png" alt="此处输入图片的描述"><br><p style="text-align:center">从 SPDY 到 HTTP/2 平稳过渡（60 分钟的流量情况）</p><br><br>该图展示了从 SPDY 至 HTTP/2 的过渡情况。 HTTP/1.1 连接并没有在该图展示出，我们分别在 23、26 以及 50 分钟的时候 ，逐渐在前端 Web 服务器上启用了 HTTP/2 支持。在此之前，流量则共同来自 Canary 机器上部署的 HTTP/2 以及生产环境中的 SPDY 。如图所示，最终我们则全线迁移到了 HTTP/2。<br><br><h3 style="text-align:center">相关观察</h3><br>我们在 canary 机器上详细监测了开启 HTTP/2 之后的性能情况，我们的观察点包括开启 HTTP/2 之后的性能效果，以及 HTTP/2 之后发现的问题，毕竟 HTTP/2 应用于生产还不太成熟。<br><br><h3 style="text-align:center">性能提升</h3><br>得益于更高效的的首部压缩算法（HPACK），我们注意到入口流量带宽的大幅度减少。<br><br><img src="/images/2016-05-13/traffic-bandwidth.png" alt="此处输入图片的描述"><br><p style="text-align:center">入口带宽流量情况（24 小时内流量）</p><br><br>上图显示了 Canary 和生产机器每台机器上面的平均流量带宽情况，我们只在 Canary 机器上开启了 HTTP/2。每台 Canary 以及生产机器上都从负载均衡服务器上接收几乎是相同的流量。如图所示，在开启 HTTP/2 之后入口带宽明显减少（将近 50%）。值得注意的是，尽管我们之前在 Canary 和生产机器上使用 SPDY ，我们并没有开启 SPDY 首部压缩支持的原因是因为一个安全问题<a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=cve-2012-4929" target="_blank" rel="noopener">(CVE-2012-4929)</a>。至于出口流量，并没有显著变化，因为响应首部只占响应流量的一小部分。<br><br><br><h3 style="text-align:center">一些注意事项</h3><p><strong>POST 请求延迟的增加。</strong>当我们在 Canary 机器上启用 HTTP/2 时，我们注意到中间延迟显著增加。下图展示了在 Canary 机器上开启 HTTP/2 后,相对于生产机器上增加了大约 50% 的请求延迟。经过调查我们发现激增的延迟来自 POST 请求。经过一番深入研究，我们发现这个问题是 NGINX 1.9.15 所固有的问题，相关讨论可以<a href="http://mailman.nginx.org/pipermail/nginx-devel/2016-May/008211.html" target="_blank" rel="noopener">参见 NGINX 的邮件列表</a>。</p><p><img src="/images/2016-05-13/request-latency.png" alt="此处输入图片的描述"></p><p style="text-align:center">激增的 50% 请求延迟（24 小时内流量）</p><p>注意，增加的 50% 请求延迟（1.5 倍）取决于特定的流量负载。在大多数情况下，对于我们来说额外多了一个 RTT（Round Trip Time），并没有对我们的性能造成关键性影响。然而如果你的负载情况包括大量琐碎并且延迟敏感的 POST 请求，那么当你升级 NGINX 到 1.9.15 的话，激增的延迟就是一个重要的问题了。</p><p><strong>小心的启用 HTTP/2 ，尤其是在客户端不可控的情况下。</strong>目前 HTTP/2 依旧不太成熟,从我们的经验来看,一些客户端、第三方库以及相关的服务器实现,并没有完全的对 HTTP/2 实现兼容。比如：</p><ul><li>Chrome 没有处理好 RST_STREAM 携带 NO_ERROR 的问题,导致在 NGINX 1.9.14 下会出现这样的问题(<a href="https://bugs.chromium.org/p/chromium/issues/detail?id=603182" target="_blank" rel="noopener">Chromium Issue #603182</a>)。相关解决方法已经纳入 NGINX 1.9.15。</li><li>当窗口空间（window space）耗尽的时候，Nghttp2 并不会发送 END_STREAM ，相关讨论请参见之前提到的 <a href="http://mailman.nginx.org/pipermail/nginx-devel/2016-May/008211.html" target="_blank" rel="noopener">NGINX 的邮件列表</a></li></ul><p>由于我们的 API 用户可能使用的是不同的第三方 HTTP 库，在为我们的 API 启用 HTTP/2 之前，我们需要进行大量的测试。</p><p></p><h3 style="text-align:center">相关调试工具</h3><br>CloundFlare 发表过一篇文章，总结一些<a href="https://blog.cloudflare.com/tools-for-debugging-testing-and-using-http-2/" target="_blank" rel="noopener">好用的 HTTP/2 调试工具</a>，除此之外，我们发现 Chrome net-internals 工具（<code>chrome://net-internals/#http2</code>）也可以派上用场。下图则是访问 www.dropbox.com 是打开新的 HTTP/2 会话时的帧交换截图。<br><img src="/images/2016-05-13/net-internals.png" alt="此处输入图片的描述"><p></p><p>总而言之，我们已经平稳过渡到了 HTTP/2 ，下面是从这篇文章的几个相关总结。</p><ul><li>在 NGINX 中启用 HTTP/2 很简单。</li><li>首部压缩会明显的减少入口带宽的流量。</li><li>NGINX 1.9.15 上会出现 POST 请求延迟的增加。</li><li>谨慎的启用 HTTP/2 ，因为还存在一些兼容性问题。</li><li>Canary 验证以及 NGINX 的错误日志检查有助于及早发现潜在的问题。</li></ul><p>我们希望这篇文章能为那些热爱网络知识并有兴趣在服务中启用 HTTP/2 的人提供帮助，我们也希望听到大家的意见反馈。</p><p>注：<br>本文由 Leo 翻译自 Dropbox 官方技术 Blog，<br>原标题：<a href="https://blogs.dropbox.com/tech/2016/05/enabling-http2-for-dropbox-Web-services-experiences-and-observations/" target="_blank" rel="noopener">Enabling HTTP/2 for Dropbox Web services: experiences and observations</a></p></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div><span style="color:#ddaf3c9c">无「民事行为能力」人慎点</span></div><button id="rewardButton" disable="enable" onclick='var qr=document.getElementById("QR");"none"===qr.style.display?qr.style.display="block":qr.style.display="none"'><span>禁</span></button><div id="QR" style="display:none"><div id="wechat" style="display:inline-block"><img id="wechat_qr" src="/images/wechatpay.png" alt="leozhang2018 微信支付"></div></div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/HTTP-2/" rel="tag"># HTTP/2</a> <a href="/tags/翻译/" rel="tag"># 翻译</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2016/04/22/理想中的 HTTP 性能/" rel="next" title="理想中的 HTTP 性能"><i class="fa fa-chevron-left"></i> 理想中的 HTTP 性能</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2016/10/04/体验 Apex.sh/" rel="prev" title="体验 Apex.sh">体验 Apex.sh <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><section class="site-overview-wrap sidebar-panel sidebar-panel-active"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/avatar.png" alt="leozhang2018"><p class="site-author-name" itemprop="name">leozhang2018</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">24</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">18</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/leozhang2018" target="_blank" title="GitHub"><i class="fab fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="https://twitter.com/leozhang2018" target="_blank" title="Twitter"><i class="fab fa-fw fa-twitter"></i>Twitter</a> </span><span class="links-of-author-item"><a href="https://instagram.com/leozhanghere" target="_blank" title="Instagram"><i class="fab fa-fw fa-instagram"></i>Instagram</a> </span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/leozhang2018/activities" target="_blank" title="Zhihu"><i class="fab fa-fw fa-zhihu"></i>Zhihu</a></span></div></div></section></div><div class="chart-map" id="chart-map"></div><div class="chart-code" id="chart-code"></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2021</span> <span class="with-love"><div class="heart"></div></span><span class="author" itemprop="copyrightHolder">诸神黄昏 人间黎明</span></div><div class="footer-custom">leozhang2018</div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="https://lib.baomitu.com/jquery/2.1.3/jquery.min.js"></script><script type="text/javascript" src="https://lib.baomitu.com/velocity/1.2.1/velocity.min.js"></script><script type="text/javascript" src="https://lib.baomitu.com/velocity/1.2.1/velocity.ui.min.js"></script><script type="text/javascript" src="/js/src/utils.js?v=6.0.3"></script><script type="text/javascript" src="/js/src/motion.js?v=6.0.3"></script><script type="text/javascript" src="/js/src/heart.js?v=6.0.3"></script><script type="text/javascript" src="/js/src/echarts.js?v=6.0.3"></script><script type="text/javascript" src="/js/src/china.js?v=6.0.3"></script><script type="text/javascript" src="/js/src/map.js?v=6.0.3"></script><script type="text/javascript" src="/js/src/code.js?v=6.0.3"></script><script type="text/javascript" src="/js/src/asciinema-player.js?v=6.0.3"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=6.0.3"></script><script type="text/javascript" src="/js/src/post-details.js?v=6.0.3"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.3"></script></body></html>